<!DOCTYPE html>
<html>
<head>
  <title>Guruvel Creativities Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Working CDNs -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; text-align: center; }
    .btn { padding: 10px 15px; margin: 5px; font-size: 16px; }
    .list { margin-top: 20px; text-align: left; }
    .list div { margin: 5px 0; }
    img.logo { width: 120px; height: auto; margin-bottom: 10px; }
  </style>
</head>
<body>
  <!-- Logo and Title -->
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png" class="logo" alt="Logo">
  <h2>üì¶ Guruvel Creativities Inventory</h2>

  <!-- Action Buttons -->
  <button class="btn" onclick="startScan('add')">‚ûï Add Stock</button>
  <button class="btn" onclick="startScan('consume')">‚ûñ Consume</button>
  <button class="btn" onclick="generateMultipleQRCodes()">üìÑ Generate QR Codes</button>
  <button class="btn" onclick="exportHistory()">üì• Export History</button>

  <div id="reader" style="width: 100%; margin-top: 20px;"></div>
  <button class="btn" id="backButton" style="display: none;" onclick="stopScan()">Go Back</button>

  <div class="list">
    <h3>Current Stock</h3>
    <div id="stockList"></div>
  </div>

  <script>
    let db = JSON.parse(localStorage.getItem('materialDB') || '{}');
    let html5QrCode;

    function saveDB() {
      localStorage.setItem('materialDB', JSON.stringify(db));
      renderList();
    }

    function renderList() {
      let stock = {};
      for (let serial in db) {
        let material = db[serial];
        stock[material] = (stock[material] || 0) + 1;
      }
      let html = Object.entries(stock).map(([mat, count]) => `<div>${mat}: ${count}</div>`).join('');
      document.getElementById('stockList').innerHTML = html || '<i>No materials in stock.</i>';
    }

    function startScan(mode) {
      const readerElement = document.getElementById("reader");
      document.getElementById("backButton").style.display = "inline";
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          let backCamera = devices.find(device => device.label.toLowerCase().includes("back"));
          const cameraId = backCamera ? backCamera.id : devices[0].id;
          html5QrCode.start(
            cameraId,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              html5QrCode.stop();
              handleScan(qrCodeMessage, mode);
            }
          ).catch(err => alert("Scan error: " + err));
        }
      });
    }

    function stopScan() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("backButton").style.display = "none";
          document.getElementById("reader").innerHTML = "";
        }).catch(err => alert("Error stopping scanner: " + err));
      }
    }

    function handleScan(serial, mode) {
      serial = serial.trim();
      let action = '';
      let timestamp = new Date().toLocaleString();

      if (mode === 'add') {
        if (db[serial]) {
          alert('Already added.');
          return;
        }
        let material = prompt("Enter material name:", "NodeMCU");
        if (material) {
          db[serial] = material.trim();
          saveDB();
          alert(`‚úÖ Added: ${material}`);
          action = 'add';
        }
      } else if (mode === 'consume') {
        if (!db[serial]) {
          alert('Serial not found.');
          return;
        }
        let material = db[serial];
        delete db[serial];
        saveDB();
        alert(`üóëÔ∏è Consumed: ${material}`);
        action = 'consume';
      }

      if (action) {
        let history = JSON.parse(localStorage.getItem('history') || '[]');
        history.push({ serial, action, timestamp });
        localStorage.setItem('history', JSON.stringify(history));
      }
    }

    let lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');

    async function generateMultipleQRCodes() {
      let count = parseInt(prompt("How many QR codes to generate?"));
      if (isNaN(count) || count <= 0) {
        alert("Invalid number.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        unit: 'mm',
        format: [110, 150]
      });

      let margin = 10, size = 20;
      let x = margin, y = margin;
      let perRow = 4;

      for (let i = 1; i <= count; i++) {
        let serialNum = lastSerialNum + i;
        let serialId = `ID${serialNum.toString().padStart(3, '0')}`;
        let url = await QRCode.toDataURL(serialId);
        doc.addImage(url, 'PNG', x, y, size, size);

        // Centered text
        let textWidth = doc.getTextWidth(serialId);
        doc.text(serialId, x + size / 2 - textWidth / 2, y + size + 5);

        x += size + 10;
        if (i % perRow === 0) {
          x = margin;
          y += size + 15;
          if (y + size > 140) {
            doc.addPage();
            y = margin;
          }
        }
      }

      lastSerialNum += count;
      localStorage.setItem('lastSerial', lastSerialNum.toString());
      doc.save('qr-codes.pdf');
    }

    function exportHistory() {
      let history = JSON.parse(localStorage.getItem('history') || '[]');
      if (history.length === 0) {
        alert("No history found.");
        return;
      }
      const ws = XLSX.utils.json_to_sheet(history);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "History");
      XLSX.writeFile(wb, "material-history.xlsx");
    }

    renderList();
  </script>
</body>
</html>
