<!DOCTYPE html>
<html>
<head>
  <title>Guruvel Creativities Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>

  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    .btn { padding: 10px 15px; margin: 5px; font-size: 16px; }
    .list { margin-top: 20px; }
    .list div { margin: 5px 0; }
    img.logo { width: 100px; }
  </style>
</head>
<body>
  <img class="logo" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png"/>
  <h2>üì¶ Guruvel Creativities Inventory</h2>
  <button class="btn" onclick="startScan('add')">‚ûï Add Stock</button>
  <button class="btn" onclick="startScan('consume')">‚ûñ Consume</button>
  <button class="btn" onclick="generateMultipleQRCodes()">üìÑ Generate QR Codes</button>
  <button class="btn" onclick="exportHistoryToExcel()">üì§ Export History</button>
  <button class="btn" onclick="resetHistory()">üóëÔ∏è Reset History</button>

  <input type="date" id="filterDate">
  <select id="filterType">
    <option value="">All</option>
    <option value="Add">Add</option>
    <option value="Consume">Consume</option>
  </select>
  <button class="btn" onclick="exportFilteredHistory()">üìÅ Export Filtered</button>

  <div id="reader" style="width: 100%; margin-top: 20px;"></div>
  <button class="btn" id="backButton" style="display: none;" onclick="stopScan()">Go Back</button>

  <div class="list">
    <h3>Current Stock</h3>
    <div id="stockList"></div>
  </div>

<script>
  // Your Firebase config here
  const firebaseConfig = {
    apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
    authDomain: "material-tracker-49dac.firebaseapp.com",
    projectId: "material-tracker-49dac",
    storageBucket: "material-tracker-49dac.appspot.com",
    messagingSenderId: "548291877330",
    appId: "1:548291877330:web:94a5d62b40058ad480100b"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const dbFirebase = firebase.firestore();

  let db = {};            // {serial: material}
  let historyLog = [];    // array of history entries
  let html5QrCode;
  let lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');

  // Save to localStorage for cache
  function saveDB() {
    localStorage.setItem('materialDB', JSON.stringify(db));
    localStorage.setItem('materialHistory', JSON.stringify(historyLog));
    renderList();
  }

  // Render current stock grouped by material
  function renderList() {
    let stock = {};
    for (let serial in db) {
      let material = db[serial];
      stock[material] = (stock[material] || 0) + 1;
    }
    let html = Object.entries(stock).map(([mat, count]) => `<div>${mat}: ${count}</div>`).join('');
    document.getElementById('stockList').innerHTML = html || '<i>No materials in stock.</i>';
  }

  // Start scanning QR
  function startScan(mode) {
    const readerElement = document.getElementById("reader");
    document.getElementById("backButton").style.display = "inline";
    html5QrCode = new Html5Qrcode("reader");
    Html5Qrcode.getCameras().then(devices => {
      if (devices.length) {
        const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
        html5QrCode.start(
          backCamera.id,
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            html5QrCode.stop();
            handleScan(qrCodeMessage, mode);
          }
        ).catch(err => alert("Scan error: " + err));
      }
    });
  }

  function stopScan() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById("backButton").style.display = "none";
        document.getElementById("reader").innerHTML = "";
      });
    }
  }

  // Handle scanned QR codes: Add or Consume materials + update Firestore
  async function handleScan(serial, mode) {
    serial = serial.trim();
    const now = new Date().toISOString();  // ISO format for better sorting in Firestore

    if (mode === 'add') {
      if (db[serial]) return alert('Already added.');
      let material = prompt("Enter or select material name:", "NodeMCU");
      if (material) {
        material = material.trim();
        db[serial] = material;
        const historyEntry = { date: now, type: 'Add', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        // Firestore writes
        try {
          await dbFirebase.collection('materials').doc(serial).set({
            material,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material added successfully.');
      }
    } else if (mode === 'consume') {
      if (!db[serial]) return alert('Serial not found.');
      const historyEntry = { date: now, type: 'Consume', id: serial, material: db[serial] };
      historyLog.push(historyEntry);
      delete db[serial];
      saveDB();

      // Firestore writes
      try {
        await dbFirebase.collection('materials').doc(serial).delete();
        await dbFirebase.collection('history').add(historyEntry);
      } catch (e) {
        alert("Firestore save error: " + e.message);
      }

      alert('Material consumed successfully.');
    }
  }

  // Generate QR codes PDF (unchanged)
  function generateMultipleQRCodes() {
    let count = parseInt(prompt("How many QR codes to generate?"));
    if (isNaN(count) || count <= 0) return alert("Invalid number.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: "mm", format: [110, 150] });
    let margin = 10, size = 20, space = 10;
    let x = margin, y = margin;
    let perRow = 4;

    let promises = [];

    for (let i = 1; i <= count; i++) {
      let serialNum = lastSerialNum + i;
      let serialId = `ID${serialNum.toString().padStart(3, '0')}`;

      promises.push(
        QRCode.toDataURL(serialId).then(url => {
          doc.addImage(url, 'PNG', x, y, size, size);
          let textX = x + size / 2;
          doc.text(serialId, textX, y + size + 5, { align: "center" });
          x += size + space;
          if (i % perRow === 0) {
            x = margin;
            y += size + 15;
            if (y + size > 140) {
              doc.addPage();
              y = margin;
            }
          }
        })
      );
    }

    Promise.all(promises).then(() => {
      lastSerialNum += count;
      localStorage.setItem('lastSerial', lastSerialNum.toString());
      doc.save('qr-codes.pdf');
    });
  }

  // Export entire history to Excel (CSV)
  function exportHistoryToExcel() {
    if (!historyLog.length) return alert('No history to export.');
    const header = "Date,Type,Serial,Material\n";
    const rows = historyLog.map(h => 
      `"${h.date}","${h.type}","${h.id}","${h.material}"`
    ).join("\n");
    const csv = header + rows;

    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'history.csv';
    a.click();
  }

  // Reset history & stock (clears Firestore too!)
  async function resetHistory() {
    if (!confirm('Clear ALL data and history? This cannot be undone.')) return;

    db = {};
    historyLog = [];
    saveDB();

    try {
      // Delete all documents in Firestore collections (warning: costly for big DB)
      const materialsSnapshot = await dbFirebase.collection('materials').get();
      materialsSnapshot.forEach(doc => dbFirebase.collection('materials').doc(doc.id).delete());

      const historySnapshot = await dbFirebase.collection('history').get();
      historySnapshot.forEach(doc => dbFirebase.collection('history').doc(doc.id).delete());

      alert('All data cleared.');
    } catch (e) {
      alert('Error clearing Firestore: ' + e.message);
    }
  }

  // Export filtered history by date and type
  function exportFilteredHistory() {
    const filterDate = document.getElementById('filterDate').value; // yyyy-mm-dd
    const filterType = document.getElementById('filterType').value;

    if (!filterDate && !filterType) return alert('Select at least one filter.');

    const filtered = historyLog.filter(h => {
      let match = true;
      if (filterDate) {
        // Compare date ignoring time
        match = match && h.date.startsWith(filterDate);
      }
      if (filterType) {
        match = match && h.type === filterType;
      }
      return match;
    });

    if (!filtered.length) return alert('No matching history records.');

    const header = "Date,Type,Serial,Material\n";
    const rows = filtered.map(h => 
      `"${h.date}","${h.type}","${h.id}","${h.material}"`
    ).join("\n");
    const csv = header + rows;

    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'filtered-history.csv';
    a.click();
  }

  // Firestore realtime sync - updates local DB and UI live across devices
  function subscribeToFirestoreUpdates() {
    dbFirebase.collection('materials').onSnapshot(snapshot => {
      db = {};
      snapshot.forEach(doc => {
        db[doc.id] = doc.data().material;
      });
      saveDB();
    });

    dbFirebase.collection('history').orderBy('date').onSnapshot(snapshot => {
      historyLog = [];
      snapshot.forEach(doc => {
        historyLog.push(doc.data());
      });
      saveDB();
    });
  }

  // On page load
  window.onload = () => {
    // Load from localStorage first
    const localDB = localStorage.getItem('materialDB');
    const localHistory = localStorage.getItem('materialHistory');
    if (localDB) db = JSON.parse(localDB);
    if (localHistory) historyLog = JSON.parse(localHistory);

    renderList();

    // Start Firestore realtime listener for live sync
    subscribeToFirestoreUpdates();
  }
</script>
</body>
</html>
