<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Guruvel Creativities Inventory</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 p-6 max-w-4xl mx-auto">
  <div class="flex items-center mb-4">
    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png" class="w-16 h-16 mr-4" />
    <h1 class="text-2xl font-bold">Guruvel Creativities Inventory</h1>
  </div>

  <div class="flex flex-wrap gap-2 mb-4">
    <button onclick="startScan('add')" class="bg-blue-600 text-white px-4 py-2 rounded">‚ûï Add Stock</button>
    <button onclick="startScan('consume')" class="bg-red-600 text-white px-4 py-2 rounded">‚ûñ Consume</button>
    <button onclick="generateMultipleQRCodes()" class="bg-yellow-600 text-white px-4 py-2 rounded">üìÑ Generate QR Codes</button>
    <button onclick="exportHistoryToExcel()" class="bg-green-700 text-white px-4 py-2 rounded">üì§ Export History</button>
    <button onclick="resetHistory()" class="bg-gray-700 text-white px-4 py-2 rounded">üóë Reset</button>
  </div>

  <div class="flex items-center gap-2 mb-4">
    <input type="date" id="filterDate" class="p-2 border rounded" />
    <select id="filterType" class="p-2 border rounded">
      <option value="">All</option>
      <option value="Add">Add</option>
      <option value="Consume">Consume</option>
    </select>
    <button onclick="exportFilteredHistory()" class="bg-indigo-600 text-white px-4 py-2 rounded">üìÅ Export Filtered</button>
  </div>

  <div id="reader" class="mb-4"></div>
  <button id="backButton" onclick="stopScan()" class="hidden bg-gray-400 text-white px-4 py-2 rounded mb-4">‚¨Ö Go Back</button>

  <h2 class="text-xl font-semibold mb-2">üì¶ Current Stock</h2>
  <div id="stockList" class="grid grid-cols-2 gap-2 bg-white p-4 rounded shadow"></div>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
      authDomain: "material-tracker-49dac.firebaseapp.com",
      projectId: "material-tracker-49dac",
      storageBucket: "material-tracker-49dac.appspot.com",
      messagingSenderId: "548291877330",
      appId: "1:548291877330:web:94a5d62b40058ad480100b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let materialDB = {}, historyLog = [];
    let html5QrCode;

    db.collection("materials").onSnapshot(snapshot => {
      materialDB = {};
      snapshot.forEach(doc => materialDB[doc.id] = doc.data().material);
      renderList();
    });

    db.collection("history").onSnapshot(snapshot => {
      historyLog = snapshot.docs.map(doc => doc.data());
    });

    function renderList() {
      const countMap = {};
      Object.values(materialDB).forEach(name => countMap[name] = (countMap[name] || 0) + 1);
      const html = Object.entries(countMap)
        .map(([name, count]) => `<div class="border p-2 rounded bg-gray-100">${name}: <strong>${count}</strong></div>`)
        .join('');
      document.getElementById("stockList").innerHTML = html || "<i>No stock available.</i>";
    }

    function startScan(mode) {
      document.getElementById("reader").innerHTML = "";
      document.getElementById("backButton").classList.remove("hidden");
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices.length) {
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            message => {
              html5QrCode.stop();
              handleScan(message.trim(), mode);
            }
          );
        }
      });
    }

    function stopScan() {
      html5QrCode?.stop().then(() => {
        document.getElementById("reader").innerHTML = "";
        document.getElementById("backButton").classList.add("hidden");
      });
    }

    function handleScan(id, mode) {
      const now = new Date().toLocaleString();

      if (mode === "add") {
        if (materialDB[id]) return alert("Already exists!");
        const name = prompt("Enter material name");
        if (!name) return;
        db.collection("materials").doc(id).set({ material: name });
        db.collection("history").add({ date: now, type: "Add", id, material: name });
      }

      if (mode === "consume") {
        if (!materialDB[id]) return alert("Not found!");
        const name = materialDB[id];
        if (confirm(`Consume "${name}"?`)) {
          db.collection("materials").doc(id).delete();
          db.collection("history").add({ date: now, type: "Consume", id, material: name });
        }
      }
    }

    async function generateMultipleQRCodes() {
  const count = parseInt(prompt("How many QR codes?"));
  if (!count || count <= 0) return;

  let maxID = 0;

  // Check max ID in materials
  const matSnap = await db.collection("materials").get();
  matSnap.forEach(doc => {
    const match = doc.id.match(/^ID(\d+)$/);
    if (match) {
      maxID = Math.max(maxID, parseInt(match[1]));
    }
  });

  // Check max ID in history
  const histSnap = await db.collection("history").get();
  histSnap.forEach(doc => {
    const match = doc.data().id?.match(/^ID(\d+)$/);
    if (match) {
      maxID = Math.max(maxID, parseInt(match[1]));
    }
  });

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "mm", format: [110, 150] });
  let margin = 10, size = 20, space = 10, x = margin, y = margin, perRow = 3;
  let promises = [];

  for (let i = 1; i <= count; i++) {
    let newID = maxID + i;
    let serial = `ID${newID}`;
    promises.push(
      QRCode.toDataURL(serial).then(url => {
        doc.addImage(url, "PNG", x, y, size, size);
        doc.text(serial, x + size / 2, y + size + 5, { align: "center" });
        x += size + space;
        if (i % perRow === 0) {
          x = margin;
          y += size + 15;
          if (y + size > 140) {
            doc.addPage();
            y = margin;
          }
        }
      })
    );
  }

  Promise.all(promises).then(() => doc.save("qr-codes.pdf"));
}


    function exportHistoryToExcel() {
      let csv = "Date,Type,Material\n";
      historyLog.forEach(e => csv += `${e.date},${e.type},${e.material || "Unknown"}\n`);
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      a.download = "history.csv"; a.click();
    }

    function exportFilteredHistory() {
      const date = document.getElementById("filterDate").value;
      const type = document.getElementById("filterType").value;

      let csv = "Date,Type,Material\n";
      historyLog.filter(e => (!date || e.date.startsWith(date)) && (!type || e.type === type))
        .forEach(e => csv += `${e.date},${e.type},${e.material || "Unknown"}\n`);

      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      a.download = "filtered-history.csv"; a.click();
    }

    function resetHistory() {
      if (!confirm("Clear all history?")) return;
      db.collection("history").get().then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      });
    }
  </script>
</body>
</html>
