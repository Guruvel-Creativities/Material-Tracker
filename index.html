<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guruvel Creativities Inventory</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Instascan JS for QR scanning -->
  <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>

  <!-- Firebase App (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6 font-sans">
  <div class="max-w-3xl w-full bg-white rounded-lg shadow-lg p-6">
    <div class="flex items-center mb-6 space-x-4">
      <img class="w-24"
        src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png"
        alt="Logo" />
      <h1 class="text-3xl font-bold text-gray-800">Guruvel Creativities Inventory</h1>
    </div>

    <div class="flex flex-wrap gap-3 mb-6">
      <button
        class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="startScan('add')">‚ûï Add Stock</button>
      <button
        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="startScan('consume')">‚ûñ Consume</button>
      <button
        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="generateMultipleQRCodes()">üìÑ Generate QR Codes</button>
      <button
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="exportHistoryToExcel()">üì§ Export History</button>
      <button
        class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="resetHistory()">üóëÔ∏è Reset History</button>
    </div>

    <div class="flex flex-wrap gap-3 items-center mb-6">
      <input type="date" id="filterDate"
        class="border border-gray-300 rounded px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      <select id="filterType"
        class="border border-gray-300 rounded px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
        <option value="">All Types</option>
        <option value="Add">Add</option>
        <option value="Consume">Consume</option>
      </select>
      <button
        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="exportFilteredHistory()">üìÅ Export Filtered</button>
    </div>

    <!-- Video preview for Instascan -->
    <video id="preview" class="w-full rounded border border-gray-300 bg-gray-50 mb-4"></video>
    <button id="backButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded shadow transition mb-6 hidden"
      onclick="stopScan()">‚¨ÖÔ∏è Go Back</button>

    <div class="bg-gray-50 rounded p-4 shadow-inner">
      <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b border-gray-300 pb-2">Current Stock</h2>
      <div id="stockList" class="text-gray-800 text-lg min-h-[100px]">
        <i>No materials in stock.</i>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
      authDomain: "material-tracker-49dac.firebaseapp.com",
      projectId: "material-tracker-49dac",
      storageBucket: "material-tracker-49dac.appspot.com",
      messagingSenderId: "548291877330",
      appId: "1:548291877330:web:94a5d62b40058ad480100b"
    };

    firebase.initializeApp(firebaseConfig);
    const dbFirebase = firebase.firestore();

    let db = {}; // {serial: material}
    let historyLog = []; // array of history entries
    let scanner; // Instascan.Scanner instance
    let currentMode = null; // 'add' or 'consume'
    let lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');

    // Save to localStorage for cache
    function saveDB() {
      localStorage.setItem('materialDB', JSON.stringify(db));
      localStorage.setItem('materialHistory', JSON.stringify(historyLog));
      renderList();
    }

    // Render current stock grouped by material
    function renderList() {
      let stock = {};
      for (let serial in db) {
        let material = db[serial];
        stock[material] = (stock[material] || 0) + 1;
      }
      let html = Object.entries(stock).map(([mat, count]) => `<div>${mat}: ${count}</div>`).join('');
      document.getElementById('stockList').innerHTML = html || '<i>No materials in stock.</i>';
    }

    // Start scanning with Instascan
    function startScan(mode) {
      currentMode = mode;
      document.getElementById("backButton").style.display = "inline";
      const videoElement = document.getElementById('preview');

      if (!scanner) {
        scanner = new Instascan.Scanner({ video: videoElement, mirror: false });
        scanner.addListener('scan', function (content) {
          stopScan();
          handleScan(content.trim(), currentMode);
        });
      }

      Instascan.Camera.getCameras().then(cameras => {
        if (cameras.length > 0) {
          // Try to use back camera first
          let selectedCam = cameras.find(cam => cam.name.toLowerCase().includes('back')) || cameras[0];
          scanner.start(selectedCam).catch(e => alert('Error starting scanner: ' + e));
        } else {
          alert('No cameras found.');
        }
      }).catch(e => alert('Error getting cameras: ' + e));
    }

    // Stop scanning
    function stopScan() {
      if (scanner) {
        scanner.stop();
      }
      document.getElementById("backButton").style.display = "none";
      const videoElement = document.getElementById('preview');
      videoElement.srcObject = null;
    }

    // Handle scanned QR codes: Add or Consume materials + update Firestore
    async function handleScan(serial, mode) {
      if (mode === 'add' && /^ID\d{3,}$/.test(serial)) {
        let material = prompt("Enter or select material name:", "NodeMCU");
        if (!material) {
          return alert("Material name is required to add.");
        }
        material = material.trim();
        if (db[serial]) return alert('Already added.');

        db[serial] = material;
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Add', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        try {
          await dbFirebase.collection('materials').doc(serial).set({
            material,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material added successfully.');
        return;
      }

      if (mode === 'add') {
        if (db[serial]) return alert('Already added.');

        let material = prompt("Enter or select material name:", "NodeMCU");
        if (!material) {
          return alert("Material name is required to add.");
        }
        material = material.trim();

        db[serial] = material;
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Add', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        try {
          await dbFirebase.collection('materials').doc(serial).set({
            material,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material added successfully.');
        return;
      }

      // Consume mode
      if (mode === 'consume') {
        if (!db[serial]) return alert('Material not in stock.');

        const material = db[serial];
        delete db[serial];
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Consume', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        try {
          await dbFirebase.collection('materials').doc(serial).delete();
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore update error: " + e.message);
        }

        alert('Material consumed successfully.');
        return;
      }

      alert("Invalid scan or mode.");
    }

    // Export history as CSV (simplified)
    function exportHistoryToExcel() {
      if (historyLog.length === 0) return alert('No history to export.');

      const rows = historyLog.map(h => [h.date, h.type, h.id, h.material]);
      let csvContent = "data:text/csv;charset=utf-8,Date,Type,Serial,Material\n";
      rows.forEach(row => {
        csvContent += row.join(",") + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "material_history.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Reset history with confirmation
    function resetHistory() {
      if (!confirm('Are you sure you want to reset the entire history? This action cannot be undone.')) return;

      historyLog = [];
      db = {};
      saveDB();

      // Clear Firestore collections (optional: only for development, handle carefully)
      // You could write a cloud function or admin script for this in production.
      alert('History and stock reset.');
    }

    // Filter export (optional to implement)
    function exportFilteredHistory() {
      alert('Filtering export not implemented yet.');
    }

    // Generate multiple QR codes - placeholder, you can expand this with QRCode lib
    function generateMultipleQRCodes() {
      alert('QR code generation not implemented yet.');
    }

    // Load saved DB and history from localStorage on page load
    function loadData() {
      let storedDB = localStorage.getItem('materialDB');
      let storedHistory = localStorage.getItem('materialHistory');
      if (storedDB) db = JSON.parse(storedDB);
      if (storedHistory) historyLog = JSON.parse(storedHistory);
      renderList();
    }

    loadData();
  </script>
</body>

</html>
