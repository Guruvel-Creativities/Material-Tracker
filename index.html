<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Guruvel Creativities Inventory</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-3xl mx-auto bg-white rounded shadow p-6">

<!-- HEADER -->
<div class="flex items-center gap-4 mb-4">
<img class="w-20" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot%20(4).png">
<h1 class="text-2xl font-bold">Guruvel Creativities Inventory</h1>
</div>

<!-- MAIN BUTTONS -->
<div class="flex flex-wrap gap-2 mb-4">
<button onclick="generateQR()" class="bg-blue-600 text-white px-4 py-2 rounded">Generate QR</button>
<button onclick="startScan('add')" class="bg-green-600 text-white px-4 py-2 rounded">Add</button>
<button onclick="startScan('consume')" class="bg-red-600 text-white px-4 py-2 rounded">Consume</button>
</div>

<!-- MATERIAL SEARCH -->
<input id="searchInput" oninput="renderStock()" placeholder="Search material..."
class="w-full border p-2 rounded mb-4">

<!-- CAMERA -->
<div id="reader"></div>
<button id="stopBtn" onclick="stopScan()" class="hidden bg-yellow-500 text-white px-3 py-1 rounded mt-2">Stop Camera</button>

<!-- STOCK -->
<div class="mt-4 bg-gray-50 p-4 rounded">
<h2 class="font-semibold mb-2">Current Stock</h2>
<div id="stockList"><i>Loading…</i></div>
</div>

<!-- EXPORT HISTORY -->
<div class="mt-6 bg-gray-50 p-4 rounded">
    <h2 class="font-semibold mb-2">Export History</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">From:</label>
            <input type="date" id="fromDate" class="border p-1.5 rounded pl-11 w-full h-10 text-sm">
        </div>
        
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">To:</label>
            <input type="date" id="toDate" class="border p-1.5 rounded pl-8 w-full h-10 text-sm">
        </div>
        
        <select id="filterType" class="border p-2 rounded h-10">
            <option value="ALL">All</option>
            <option value="Add">Add</option>
            <option value="Consume">Consume</option>
        </select>
        
        <button onclick="exportCSV()" class="bg-indigo-600 text-white rounded px-4 h-10">Export CSV</button>
    </div>
</div>

</div>

<script>
/* FIREBASE */
firebase.initializeApp({
 apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
 authDomain: "material-tracker-49dac.firebaseapp.com",
 projectId: "material-tracker-49dac"
});
const db = firebase.firestore();

let stock={}, history=[], qr;

/* REALTIME DATA */
db.collection("materials").onSnapshot(s=>{
 stock={}; s.forEach(d=>stock[d.id]=d.data().material); renderStock();
});
db.collection("history").orderBy("date","desc").onSnapshot(s=>{
 history=[]; s.forEach(d=>history.push(d.data()));
});

/* RENDER STOCK */
function renderStock(){
 const t=document.getElementById("searchInput").value.toLowerCase();
 let c={};
 Object.values(stock).forEach(m=>{ if(m.toLowerCase().includes(t)) c[m]=(c[m]||0)+1; });
 document.getElementById("stockList").innerHTML=
 Object.entries(c).map(([m,n],i)=>`<div class="flex justify-between border-b py-1">
 <span>${i+1}. ${m}</span><b>${n}</b></div>`).join("") || "<i>No match</i>";
}

/* CAMERA */
function startScan(mode){
 document.getElementById("stopBtn").classList.remove("hidden");
 qr=new Html5Qrcode("reader");
 qr.start({facingMode:"environment"},{fps:10,qrbox:250},t=>{qr.stop();handleScan(t,mode);});
}
function stopScan(){ qr?.stop(); reader.innerHTML=""; stopBtn.classList.add("hidden"); }

/* SCAN LOGIC */
async function handleScan(s,m){
 s=s.trim(); if(!s.startsWith("ID")) return alert("Invalid QR");
 if(m==="add"){
  if(stock[s]) return alert("Already exists");
  let mat=prompt("Material name?"); if(!mat) return;
  await db.collection("materials").doc(s).set({material:mat});
  await db.collection("history").add({serial:s,material:mat,type:"Add",date:new Date()});
 }
 if(m==="consume"){
  if(!stock[s]) return alert("Not found");
  let mat=stock[s];
  await db.collection("materials").doc(s).delete();
  await db.collection("history").add({serial:s,material:mat,type:"Consume",date:new Date()});
 }
}

/* EXPORT CSV with single or range date */
function exportCSV(){
 const from=document.getElementById("fromDate").value;
 const to=document.getElementById("toDate").value;
 const t=document.getElementById("filterType").value;
 let rows=[["Serial","Material","Type","Date"]];

 history.filter(h=>{
   let ok=true;
   if(t!=="ALL") ok=h.type===t;
   let dt=new Date(h.date.seconds*1000);
   if(from) ok=ok && dt>=new Date(from);
   if(to) ok=ok && dt<=new Date(to+"T23:59:59");
   return ok;
 }).forEach(h=>rows.push([h.serial,h.material,h.type,new Date(h.date.seconds*1000).toLocaleString()]));

 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"Inventory_Data");
 XLSX.writeFile(wb,"Inventory_History.csv");
}

/* GENERATE QR PDF (150mm×100mm) - 4 QR per row × 6 rows = 24 per page */
async function generateQR(){
 const n=parseInt(prompt("Number of QR codes?")); if(!n) return;
 let last=0;
 const snap=await db.collection("materials").get();
 snap.forEach(d=>{ const x=parseInt(d.id.replace("ID","")); if(x>last) last=x; });

 const {jsPDF}=window.jspdf;
 const pdf=new jsPDF({unit:"mm",format:[100,150]});
 
 let page=1;
 // Calculate starting position to center the grid
 const qrSize=15; // QR size 15mm
 const qrPerRow=4;
 const qrPerColumn=6;
 const horizontalSpacing=20; // 15mm QR + 5mm spacing
 const verticalSpacing=22; // 15mm QR + 2mm text + 5mm spacing
 const totalWidth=qrPerRow*horizontalSpacing;
 const startX=(100-totalWidth)/2+5; // Center the grid horizontally
 const startY=10; // Start 10mm from top
 
 let x=startX;
 let y=startY;
 const qrPerPage=qrPerRow*qrPerColumn; // 4×6=24
 
 for(let i=1;i<=n;i++){
   const id="ID"+String(++last).padStart(3,"0");
   const c=document.createElement("canvas");
   await QRCode.toCanvas(c,id,{width:150}); // Increased canvas size for better quality
   
   // Add QR code (15mm × 15mm)
   pdf.addImage(c,"PNG",x,y,qrSize,qrSize);
   
   // Add ID text below QR (smaller text)
   pdf.setFontSize(6);
   pdf.text(id,x+(qrSize/2),y+qrSize+2.5,{align:"center"});
   
   // Move to next column
   x+=horizontalSpacing;
   
   // Check if we need to move to next row
   if(i%qrPerRow===0){
     x=startX;
     y+=verticalSpacing;
   }
   
   // Check if we need a new page
   if(i%qrPerPage===0 && i<n){
     pdf.addPage([100,150]); // Add new page with same dimensions
     page++;
     x=startX;
     y=startY;
   }
 }
 
 pdf.save("QR_Codes.pdf");
}
</script>
</body>
</html>
