<!DOCTYPE html>
<html>
<head>
  <title>Guruvel Creativities Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    .btn { padding: 10px 15px; margin: 5px; font-size: 16px; }
    .list { margin-top: 20px; }
    .list div { margin: 5px 0; }
    img.logo { width: 100px; }
  </style>
</head>
<body>
  <img class="logo" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png"/>
  <h2>üì¶ Guruvel Creativities Inventory</h2>
  <button class="btn" onclick="startScan('add')">‚ûï Add Stock</button>
  <button class="btn" onclick="startScan('consume')">‚ûñ Consume</button>
  <button class="btn" onclick="generateMultipleQRCodes()">üìÑ Generate QR Codes</button>
  <button class="btn" onclick="exportHistoryToExcel()">üì§ Export History</button>
  <button class="btn" onclick="resetHistory()">üóëÔ∏è Reset History</button>
  <input type="date" id="filterDate">
  <select id="filterType">
    <option value="">All</option>
    <option value="Add">Add</option>
    <option value="Consume">Consume</option>
  </select>
  <button class="btn" onclick="exportFilteredHistory()">üìÅ Export Filtered</button>

  <div id="reader" style="width: 100%; margin-top: 20px;"></div>
  <button class="btn" id="backButton" style="display: none;" onclick="stopScan()">Go Back</button>

  <div class="list">
    <h3>Current Stock</h3>
    <div id="stockList"></div>
  </div>

  <script>
    let db = JSON.parse(localStorage.getItem('materialDB') || '{}');
    let historyLog = JSON.parse(localStorage.getItem('materialHistory') || '[]');
    let html5QrCode;
    let lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');

    function saveDB() {
      localStorage.setItem('materialDB', JSON.stringify(db));
      localStorage.setItem('materialHistory', JSON.stringify(historyLog));
      renderList();
    }

    function renderList() {
      let stock = {};
      for (let serial in db) {
        let material = db[serial];
        stock[material] = (stock[material] || 0) + 1;
      }
      let html = Object.entries(stock).map(([mat, count]) => `<div>${mat}: ${count}</div>`).join('');
      document.getElementById('stockList').innerHTML = html || '<i>No materials in stock.</i>';
    }

    function startScan(mode) {
      const readerElement = document.getElementById("reader");
      document.getElementById("backButton").style.display = "inline";
      html5QrCode = new Html5Qrcode("reader");
      Html5Qrcode.getCameras().then(devices => {
        if (devices.length) {
          const backCamera = devices.find(d => d.label.toLowerCase().includes("back")) || devices[0];
          html5QrCode.start(
            backCamera.id,
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              html5QrCode.stop();
              handleScan(qrCodeMessage, mode);
            }
          ).catch(err => alert("Scan error: " + err));
        }
      });
    }

    function stopScan() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("backButton").style.display = "none";
          document.getElementById("reader").innerHTML = "";
        });
      }
    }

    function handleScan(serial, mode) {
      serial = serial.trim();
      const now = new Date().toLocaleString();

      if (mode === 'add') {
        if (db[serial]) return alert('Already added.');
        let material = prompt("Enter or select material name:", "NodeMCU");
        if (material) {
          db[serial] = material.trim();
          historyLog.push({ date: now, type: 'Add', id: serial, material });
          saveDB();
          alert('Material added successfully.');
        }
      } else if (mode === 'consume') {
        if (!db[serial]) return alert('Serial not found.');
        historyLog.push({ date: now, type: 'Consume', id: serial, material: db[serial] });
        delete db[serial];
        saveDB();
        alert('Material consumed successfully.');
      }
    }

    function generateMultipleQRCodes() {
      let count = parseInt(prompt("How many QR codes to generate?"));
      if (isNaN(count) || count <= 0) return alert("Invalid number.");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: [110, 150] });
      let margin = 10, size = 20, space = 10;
      let x = margin, y = margin;
      let perRow = 4;

      let promises = [];

      for (let i = 1; i <= count; i++) {
        let serialNum = lastSerialNum + i;
        let serialId = `ID${serialNum.toString().padStart(3, '0')}`;

        promises.push(
          QRCode.toDataURL(serialId).then(url => {
            doc.addImage(url, 'PNG', x, y, size, size);
            let textX = x + size / 2;
            doc.text(serialId, textX, y + size + 5, { align: "center" });
            x += size + space;
            if (i % perRow === 0) {
              x = margin;
              y += size + 15;
              if (y + size > 140) {
                doc.addPage();
                y = margin;
              }
            }
          })
        );
      }

      Promise.all(promises).then(() => {
        lastSerialNum += count;
        localStorage.setItem('lastSerial', lastSerialNum.toString());
        doc.save('qr-codes.pdf');
      });
    }

    function exportHistoryToExcel() {
      let csv = 'Date,Type,Material Name\n';
      historyLog.forEach(entry => {
        let materialName = db[entry.id] || entry.material || 'Unknown';
        csv += `${entry.date},${entry.type},${materialName}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'material-history.csv';
      a.click();
    }

    function exportFilteredHistory() {
      let selectedDate = document.getElementById('filterDate').value;
      let selectedType = document.getElementById('filterType').value;

      let filtered = historyLog.filter(entry => {
        let matchDate = !selectedDate || entry.date.startsWith(selectedDate);
        let matchType = !selectedType || entry.type === selectedType;
        return matchDate && matchType;
      });

      let csv = 'Date,Type,Material Name\n';
      filtered.forEach(entry => {
        csv += `${entry.date},${entry.type},${entry.material || db[entry.id] || 'Unknown'}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'filtered-material-history.csv';
      a.click();
    }

    function resetHistory() {
      if (confirm("Are you sure you want to clear the history?")) {
        historyLog = [];
        saveDB();
        alert("History reset done.");
      }
    }

    renderList();
  </script>
</body>
</html>
