<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Guruvel Creativities Inventory</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- QuaggaJS for reliable iOS QR scanning -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
    /* Scanner container */
    #scanner-container {
        position: relative;
        width: 100%;
        max-width: 320px;
        margin: 0 auto;
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    #interactive {
        width: 100%;
        height: 300px;
        background: #000;
        border-radius: 12px;
    }
    
    /* Scanner overlay */
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }
    
    .scanner-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 250px;
        height: 250px;
        border: 4px solid #10B981;
        border-radius: 12px;
        background: transparent;
        box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
    }
    
    .scanner-corner {
        position: absolute;
        width: 40px;
        height: 40px;
        border-color: #10B981;
    }
    
    .corner-tl {
        top: -4px;
        left: -4px;
        border-top: 6px solid;
        border-left: 6px solid;
        border-top-left-radius: 8px;
    }
    
    .corner-tr {
        top: -4px;
        right: -4px;
        border-top: 6px solid;
        border-right: 6px solid;
        border-top-right-radius: 8px;
    }
    
    .corner-bl {
        bottom: -4px;
        left: -4px;
        border-bottom: 6px solid;
        border-left: 6px solid;
        border-bottom-left-radius: 8px;
    }
    
    .corner-br {
        bottom: -4px;
        right: -4px;
        border-bottom: 6px solid;
        border-right: 6px solid;
        border-bottom-right-radius: 8px;
    }
    
    .scan-line {
        position: absolute;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, transparent, #10B981, transparent);
        animation: scanLine 1.8s ease-in-out infinite;
        border-radius: 2px;
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
    }
    
    @keyframes scanLine {
        0% { top: 10%; opacity: 0.8; }
        50% { top: 90%; opacity: 1; }
        100% { top: 10%; opacity: 0.8; }
    }
    
    /* Torch/flash button */
    .torch-btn {
        position: absolute;
        bottom: 15px;
        left: 15px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 20;
        transition: all 0.3s;
    }
    
    .torch-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.05);
    }
    
    .torch-btn.active {
        background: #F59E0B;
        color: #000;
    }
    
    /* Camera switch button */
    .camera-switch-btn {
        position: absolute;
        bottom: 15px;
        right: 15px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 20;
        transition: all 0.3s;
    }
    
    .camera-switch-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.05);
    }
    
    /* Loading animation */
    .scanning-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60px;
        height: 60px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        border-top-color: #10B981;
        animation: spin 1s linear infinite;
        z-index: 5;
    }
    
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Status message */
    .scan-status {
        position: absolute;
        bottom: -25px;
        left: 0;
        right: 0;
        text-align: center;
        color: #10B981;
        font-size: 14px;
        font-weight: 500;
        z-index: 15;
    }
</style>
</head>

<body class="bg-gray-100 p-4 md:p-6">
<div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-4 md:p-6">

<!-- HEADER -->
<div class="flex items-center gap-4 mb-4">
<img class="w-16 md:w-20" src="https://raw.githubusercontent.com/Guruvel-Creativities/Material-Tracker/main/Logo.PNG" alt="Guruvel Creativities Logo">
<h1 class="text-xl md:text-2xl font-bold">Guruvel Creativities Inventory</h1>
</div>

<!-- MAIN BUTTONS -->
<div class="flex flex-wrap gap-2 mb-4">
<button onclick="generateQR()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">Generate QR</button>
<button onclick="startScanner('add')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200">Add</button>
<button onclick="startScanner('consume')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">Consume</button>
</div>

<!-- MATERIAL SEARCH -->
<input id="searchInput" oninput="renderStock()" placeholder="ðŸ” Search material..."
class="w-full border border-gray-300 p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">

<!-- SCANNER CONTAINER -->
<div id="scanner-section" class="hidden mb-6">
    <div id="scanner-container">
        <div id="interactive" class="view-port"></div>
        <div class="scanning-loader"></div>
        <div class="scanner-overlay">
            <div class="scanner-frame">
                <div class="scanner-corner corner-tl"></div>
                <div class="scanner-corner corner-tr"></div>
                <div class="scanner-corner corner-bl"></div>
                <div class="scanner-corner corner-br"></div>
                <div class="scan-line"></div>
            </div>
        </div>
        <button id="torch-btn" class="torch-btn hidden" title="Toggle Flash">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </button>
        <button id="camera-switch-btn" class="camera-switch-btn hidden" title="Switch Camera">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
        <div class="scan-status" id="scan-status">Position QR code inside frame</div>
    </div>
    
    <div class="text-center mt-8">
        <button onclick="stopScanner()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition duration-200">
            Stop Scanner
        </button>
        <button onclick="toggleFullscreen()" class="ml-3 bg-purple-500 hover:bg-purple-600 text-white px-6 py-2.5 rounded-lg text-sm font-medium transition duration-200">
            Fullscreen
        </button>
    </div>
    
    <div class="mt-4 text-center text-sm text-gray-600">
        <p>ðŸ“± <strong>Tips:</strong> Hold steady, good lighting, move closer for small QR codes</p>
    </div>
</div>

<!-- STOCK -->
<div class="mt-6 bg-gray-50 p-4 rounded-lg">
<h2 class="font-semibold mb-3 text-lg">Current Stock</h2>
<div id="stockList" class="max-h-60 overflow-y-auto">
    <div class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-500">Loading stock...</p>
    </div>
</div>
</div>

<!-- EXPORT HISTORY -->
<div class="mt-6 bg-gray-50 p-4 rounded-lg">
    <h2 class="font-semibold mb-3 text-lg">Export History</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div class="relative">
            <label class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">From:</label>
            <input type="date" id="fromDate" class="border border-gray-300 p-3 rounded-lg pl-16 w-full text-sm">
        </div>
        
        <div class="relative">
            <label class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">To:</label>
            <input type="date" id="toDate" class="border border-gray-300 p-3 rounded-lg pl-12 w-full text-sm">
        </div>
        
        <select id="filterType" class="border border-gray-300 p-3 rounded-lg text-sm">
            <option value="ALL">All Types</option>
            <option value="Add">Add Only</option>
            <option value="Consume">Consume Only</option>
        </select>
        
        <button onclick="exportCSV()" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 font-medium transition duration-200">
            Export CSV
        </button>
    </div>
</div>

</div>

<script>
/* FIREBASE INIT */
firebase.initializeApp({
 apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
 authDomain: "material-tracker-49dac.firebaseapp.com",
 projectId: "material-tracker-49dac"
});
const db = firebase.firestore();

/* DATA STORAGE */
let stock = {}, history = [];
let currentScanMode = null;
let isProcessingScan = false;
let isScannerActive = false;
let torchEnabled = false;
let currentFacingMode = 'environment'; // 'environment' for back, 'user' for front

/* REALTIME MATERIAL DATA */
db.collection("materials").onSnapshot(s => {
    stock = {}; 
    s.forEach(d => stock[d.id] = d.data().material); 
    renderStock();
});

db.collection("history").orderBy("date", "desc").onSnapshot(s => {
    history = []; 
    s.forEach(d => history.push(d.data()));
});

/* RENDER STOCK */
function renderStock() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    let counted = {};
    
    Object.values(stock).forEach(material => {
        if (material.toLowerCase().includes(searchTerm)) {
            counted[material] = (counted[material] || 0) + 1;
        }
    });
    
    const stockEntries = Object.entries(counted);
    
    if (stockEntries.length === 0) {
        document.getElementById("stockList").innerHTML = `
            <div class="text-center py-8">
                <p class="text-gray-500">No materials found</p>
                ${searchTerm ? '<p class="text-sm text-gray-400 mt-1">Try a different search term</p>' : ''}
            </div>`;
        return;
    }
    
    const stockListHTML = stockEntries.map(([material, count], index) => `
        <div class="flex justify-between items-center border-b border-gray-200 py-3 px-2 hover:bg-gray-100 transition duration-150">
            <div class="flex items-center">
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold mr-3 px-2.5 py-0.5 rounded">${index + 1}</span>
                <span class="text-gray-800">${material}</span>
            </div>
            <span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full">${count}</span>
        </div>
    `).join('');
    
    document.getElementById("stockList").innerHTML = stockListHTML;
}

/* HIGH PERFORMANCE QR SCANNER WITH QUAGGAS */
async function startScanner(mode) {
    if (isProcessingScan || isScannerActive) {
        console.log("Scanner is already active");
        return;
    }
    
    currentScanMode = mode;
    isScannerActive = true;
    
    // Show scanner section
    document.getElementById("scanner-section").classList.remove("hidden");
    updateScanStatus("Initializing scanner...");
    
    try {
        // Configure QuaggaJS for optimal QR scanning
        await Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    width: { min: 640, ideal: 1280 },
                    height: { min: 480, ideal: 720 },
                    facingMode: currentFacingMode,
                    aspectRatio: { min: 1, max: 2 }
                },
                area: { // Define scanning area (center 60%)
                    top: "20%",
                    right: "20%",
                    left: "20%",
                    bottom: "20%"
                }
            },
            decoder: {
                readers: [
                    "qrcode_reader",
                    "code_128_reader",
                    "ean_reader",
                    "ean_8_reader",
                    "code_39_reader",
                    "code_39_vin_reader",
                    "codabar_reader",
                    "upc_reader",
                    "upc_e_reader",
                    "i2of5_reader"
                ],
                debug: {
                    drawBoundingBox: false,
                    showFrequency: false,
                    drawScanline: false,
                    showPattern: false
                },
                multiple: false
            },
            locate: true,
            frequency: 30, // High frequency for fast scanning
            numOfWorkers: navigator.hardwareConcurrency ? Math.min(4, navigator.hardwareConcurrency) : 2,
            locate: true
        }, function(err) {
            if (err) {
                console.error("Quagga initialization error:", err);
                updateScanStatus("Failed to initialize scanner");
                showError("Scanner Error", "Failed to start camera: " + err.message);
                stopScanner();
                return;
            }
            
            console.log("Quagga initialized successfully");
            updateScanStatus("Ready - Scan QR code");
            
            // Hide loading animation
            document.querySelector('.scanning-loader').style.display = 'none';
            
            // Show torch button if available
            checkTorchAvailability();
            
            // Show camera switch button
            document.getElementById('camera-switch-btn').classList.remove('hidden');
            
            Quagga.start();
            
            // Handle successful scans
            Quagga.onDetected(async function(result) {
                if (isProcessingScan) return;
                
                const code = result.codeResult.code;
                console.log("QR detected:", code);
                
                // Visual and haptic feedback
                updateScanStatus("âœ“ QR Detected!");
                document.querySelector('.scan-line').style.background = 'linear-gradient(90deg, transparent, #10B981, #10B981, #10B981, transparent)';
                
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                playScanSound();
                
                // Stop scanner temporarily
                Quagga.stop();
                isProcessingScan = true;
                
                // Process the scan
                await processScannedCode(code, mode);
                
                // Restart scanner if still active
                if (isScannerActive) {
                    setTimeout(() => {
                        document.querySelector('.scan-line').style.background = 'linear-gradient(90deg, transparent, #10B981, transparent)';
                        updateScanStatus("Ready - Scan next QR");
                        Quagga.start();
                        isProcessingScan = false;
                    }, 1000);
                }
            });
            
            // Handle processing errors
            Quagga.onProcessed(function(result) {
                if (result) {
                    // You can add visual feedback for processing here
                }
            });
        });
        
    } catch (error) {
        console.error("Scanner error:", error);
        showError("Camera Error", 
            "Please ensure:\n\n" +
            "1. Camera permissions are granted\n" +
            "2. You're using HTTPS (required)\n" +
            "3. Try a different browser\n\n" +
            "Error: " + error.message);
        stopScanner();
    }
}

/* CHECK TORCH/FLASH AVAILABILITY */
function checkTorchAvailability() {
    // This is a simplified check - in production, you'd use the ImageCapture API
    const torchBtn = document.getElementById('torch-btn');
    
    // Only show torch button on mobile devices with rear camera
    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent) && 
        currentFacingMode === 'environment') {
        torchBtn.classList.remove('hidden');
    }
}

/* TOGGLE TORCH/FLASH */
function toggleTorch() {
    if (!isScannerActive) return;
    
    torchEnabled = !torchEnabled;
    const torchBtn = document.getElementById('torch-btn');
    
    if (torchEnabled) {
        torchBtn.classList.add('active');
        torchBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>';
    } else {
        torchBtn.classList.remove('active');
        torchBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>';
    }
    
    // Note: Actual torch control requires ImageCapture API
    updateScanStatus(torchEnabled ? "Flash ON" : "Flash OFF");
}

/* SWITCH CAMERA */
function switchCamera() {
    if (!isScannerActive) return;
    
    currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
    updateScanStatus("Switching camera...");
    
    // Stop and restart scanner with new camera
    Quagga.stop();
    setTimeout(() => {
        stopScanner();
        setTimeout(() => startScanner(currentScanMode), 500);
    }, 300);
}

/* STOP SCANNER */
function stopScanner() {
    if (Quagga) {
        try {
            Quagga.stop();
        } catch (e) {
            console.log("Error stopping Quagga:", e);
        }
    }
    
    isScannerActive = false;
    isProcessingScan = false;
    torchEnabled = false;
    
    // Hide scanner section
    document.getElementById("scanner-section").classList.add("hidden");
    
    // Reset UI elements
    document.querySelector('.scanning-loader').style.display = 'block';
    document.getElementById('torch-btn').classList.add('hidden');
    document.getElementById('camera-switch-btn').classList.add('hidden');
    document.getElementById('torch-btn').classList.remove('active');
}

/* UPDATE SCAN STATUS */
function updateScanStatus(message) {
    const statusElement = document.getElementById('scan-status');
    if (statusElement) {
        statusElement.textContent = message;
        
        // Add visual feedback for success
        if (message.includes("âœ“")) {
            statusElement.style.color = "#10B981";
            statusElement.style.fontWeight = "600";
        } else {
            statusElement.style.color = "";
            statusElement.style.fontWeight = "";
        }
    }
}

/* PLAY SCAN SOUND */
function playScanSound() {
    try {
        // Create a simple beep sound
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        // Audio not supported, ignore
    }
}

/* SHOW ERROR MESSAGE */
function showError(title, message) {
    alert(`âŒ ${title}\n\n${message}`);
}

/* TOGGLE FULLSCREEN */
function toggleFullscreen() {
    const scannerContainer = document.getElementById('scanner-container');
    
    if (!document.fullscreenElement) {
        if (scannerContainer.requestFullscreen) {
            scannerContainer.requestFullscreen();
        } else if (scannerContainer.webkitRequestFullscreen) {
            scannerContainer.webkitRequestFullscreen();
        } else if (scannerContainer.msRequestFullscreen) {
            scannerContainer.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}

/* PROCESS SCANNED CODE */
async function processScannedCode(serial, mode) {
    serial = serial.trim();
    
    // Validate QR format
    if (!serial.startsWith("ID")) {
        showError("Invalid QR Code", `Expected format: ID###\nScanned: ${serial}`);
        return;
    }
    
    if (mode === "add") {
        if (stock[serial]) {
            showError("Already Exists", 
                `Serial: ${serial}\nMaterial: ${stock[serial]}\n\nThis item is already in stock.`);
            return;
        }
        
        let materialName = prompt(`ðŸ“ Enter Material Name for:\n\nSerial: ${serial}\n\nMaterial Name:`);
        
        if (!materialName || materialName.trim() === "") {
            return;
        }
        
        materialName = materialName.trim();
        
        try {
            await db.collection("materials").doc(serial).set({ material: materialName });
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Add",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`âœ… Added Successfully!\n\nMaterial: ${materialName}\nSerial: ${serial}`);
            renderStock();
            
        } catch (error) {
            showError("Database Error", "Failed to save: " + error.message);
        }
    }
    
    if (mode === "consume") {
        if (!stock[serial]) {
            showError("Not Found", 
                `Serial: ${serial}\n\nThis item is not in the inventory.`);
            return;
        }
        
        let materialName = stock[serial];
        
        try {
            await db.collection("materials").doc(serial).delete();
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Consume",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`âœ… Consumed Successfully!\n\nMaterial: ${materialName}\nSerial: ${serial}`);
            renderStock();
            
        } catch (error) {
            showError("Database Error", "Failed to update: " + error.message);
        }
    }
}

/* EXPORT CSV */
function exportCSV() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const filterType = document.getElementById("filterType").value;
    
    let rows = [["Serial", "Material", "Type", "Date"]];
    
    history.filter(entry => {
        let matches = true;
        if (filterType !== "ALL") matches = entry.type === filterType;
        
        const entryDate = new Date(entry.date.seconds * 1000);
        if (from) matches = matches && entryDate >= new Date(from);
        if (to) matches = matches && entryDate <= new Date(to + "T23:59:59");
        
        return matches;
    }).forEach(entry => {
        rows.push([
            entry.serial,
            entry.material,
            entry.type,
            new Date(entry.date.seconds * 1000).toLocaleString()
        ]);
    });
    
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(rows), "Inventory_Data");
    XLSX.writeFile(workbook, `Inventory_History_${new Date().toISOString().split('T')[0]}.csv`);
}

/* GENERATE QR PDF */
async function generateQR() {
    const n = parseInt(prompt("How many QR codes to generate?"));
    if (!n || n < 1) {
        alert("Please enter a valid number");
        return;
    }
    
    const settingsDoc = await db.collection("settings").doc("qr").get();
    let last = 900;
    
    if (settingsDoc.exists) {
        last = settingsDoc.data().lastNumber || 900;
        if (last < 900) last = 900;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "mm", format: [100, 150] });
    
    const qrSize = 25;
    const textGap = 3;
    const fontSize = 8;
    const marginX = 5;
    const marginY = 5;
    const qrPerRow = 4;
    const spacingX = (100 - 2 * marginX - qrPerRow * qrSize) / (qrPerRow - 1);
    const spacingY = 7;
    
    let x = marginX;
    let y = marginY;
    let col = 0;
    
    alert(`ðŸ”„ Generating ${n} QR codes... Please wait.`);
    
    for (let i = 1; i <= n; i++) {
        const id = "ID" + String(++last).padStart(3, "0");
        
        const canvas = document.createElement("canvas");
        await QRCode.toCanvas(canvas, id, {
            width: qrSize * 4,
            margin: 2,
            color: { dark: "#000000", light: "#FFFFFF" },
            errorCorrectionLevel: 'H' // High error correction
        });
        
        pdf.addImage(canvas, "PNG", x, y, qrSize, qrSize);
        pdf.setFontSize(fontSize);
        pdf.text(id, x + qrSize / 2, y + qrSize + textGap, { align: "center" });
        
        col++;
        if (col < qrPerRow) {
            x += qrSize + spacingX;
        } else {
            col = 0;
            x = marginX;
            y += qrSize + textGap + spacingY;
            
            if (y + qrSize + textGap > 150 - marginY) {
                pdf.addPage([100, 150]);
                y = marginY;
            }
        }
    }
    
    const filename = `QR_Codes_ID${String(last - n + 1).padStart(3, '0')}_to_ID${String(last).padStart(3, '0')}.pdf`;
    pdf.save(filename);
    
    await db.collection("settings").doc("qr").set({ lastNumber: last });
    
    alert(`âœ… Generated ${n} QR Codes!\n\nFrom: ID${String(last - n + 1).padStart(3, '0')}\nTo: ID${String(last).padStart(3, '0')}\n\nFile: ${filename}`);
}

/* CLEANUP */
window.addEventListener('beforeunload', stopScanner);
window.addEventListener('pagehide', stopScanner);
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopScanner();
    }
});

// Event listeners for buttons
document.getElementById('torch-btn').addEventListener('click', toggleTorch);
document.getElementById('camera-switch-btn').addEventListener('click', switchCamera);

</script>
</body>
</html>
