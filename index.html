<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Guruvel Creativities Inventory</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- Use Instascan for better iOS compatibility -->
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>

<style>
    #scanner-container {
        position: relative;
        width: 100%;
        max-width: 320px;
        margin: 0 auto;
        overflow: hidden;
    }
    
    #scanner-video {
        width: 100%;
        height: auto;
        border-radius: 8px;
        transform: scaleX(-1); /* Mirror for front camera */
    }
    
    .scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
    }
    
    .scan-frame {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 70%;
        height: 70%;
        border: 3px solid #3b82f6;
        border-radius: 8px;
        background: transparent;
    }
    
    .scan-line {
        position: absolute;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, transparent, #3b82f6, transparent);
        animation: scan 1.5s ease-in-out infinite;
        border-radius: 2px;
    }
    
    @keyframes scan {
        0% { top: 5%; }
        100% { top: 95%; }
    }
    
    .camera-switch {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        z-index: 10;
    }
</style>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-3xl mx-auto bg-white rounded shadow p-6">

<!-- HEADER -->
<div class="flex items-center gap-4 mb-4">
<img class="w-20" src="https://raw.githubusercontent.com/Guruvel-Creativities/Material-Tracker/main/Logo.PNG" alt="Guruvel Creativities Logo">
<h1 class="text-2xl font-bold">Guruvel Creativities Inventory</h1>
</div>

<!-- MAIN BUTTONS -->
<div class="flex flex-wrap gap-2 mb-4">
<button onclick="generateQR()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Generate QR</button>
<button onclick="startScan('add')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add</button>
<button onclick="startScan('consume')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Consume</button>
</div>

<!-- MATERIAL SEARCH -->
<input id="searchInput" oninput="renderStock()" placeholder="Search material..."
class="w-full border p-2 rounded mb-4">

<!-- CAMERA CONTAINER -->
<div id="cameraContainer" class="hidden mb-4">
    <div id="scanner-container">
        <video id="scanner-video" playsinline></video>
        <div class="scan-overlay">
            <div class="scan-frame">
                <div class="scan-line"></div>
            </div>
        </div>
        <button onclick="switchCamera()" class="camera-switch" title="Switch camera">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>
    </div>
    
    <div class="text-center text-sm text-gray-600 mt-2">
        <div class="inline-flex items-center gap-1">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span id="scan-status">Position QR code in frame</span>
        </div>
    </div>
    
    <div class="text-center mt-3">
        <button onclick="stopScan()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1.5 rounded text-sm">Stop Camera</button>
    </div>
</div>

<!-- STOCK -->
<div class="mt-4 bg-gray-50 p-4 rounded">
<h2 class="font-semibold mb-2">Current Stock</h2>
<div id="stockList"><i>Loading…</i></div>
</div>

<!-- EXPORT HISTORY -->
<div class="mt-6 bg-gray-50 p-4 rounded">
    <h2 class="font-semibold mb-2">Export History</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">From:</label>
            <input type="date" id="fromDate" class="border p-1.5 rounded pl-11 w-full h-10 text-sm">
        </div>
        
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">To:</label>
            <input type="date" id="toDate" class="border p-1.5 rounded pl-8 w-full h-10 text-sm">
        </div>
        
        <select id="filterType" class="border p-2 rounded h-10">
            <option value="ALL">All</option>
            <option value="Add">Add</option>
            <option value="Consume">Consume</option>
        </select>
        
        <button onclick="exportCSV()" class="bg-indigo-600 text-white rounded px-4 h-10 hover:bg-indigo-700">Export CSV</button>
    </div>
</div>

</div>

<script>
/* FIREBASE INIT */
firebase.initializeApp({
 apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
 authDomain: "material-tracker-49dac.firebaseapp.com",
 projectId: "material-tracker-49dac"
});
const db = firebase.firestore();

/* DATA STORAGE */
let stock = {}, history = [], scanner = null, currentScanMode = null;
let isProcessingScan = false;
let currentCamera = 'environment'; // 'environment' for back, 'user' for front

/* REALTIME MATERIAL DATA */
db.collection("materials").onSnapshot(s => {
    stock = {}; 
    s.forEach(d => stock[d.id] = d.data().material); 
    renderStock();
});

db.collection("history").orderBy("date", "desc").onSnapshot(s => {
    history = []; 
    s.forEach(d => history.push(d.data()));
});

/* RENDER STOCK */
function renderStock() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    let counted = {};
    
    Object.values(stock).forEach(material => {
        if (material.toLowerCase().includes(searchTerm)) {
            counted[material] = (counted[material] || 0) + 1;
        }
    });
    
    const stockListHTML = Object.entries(counted).map(([material, count], index) => 
        `<div class="flex justify-between border-b py-1 hover:bg-gray-100">
            <span>${index + 1}. ${material}</span><b>${count}</b>
        </div>`
    ).join("") || "<i>No match</i>";
    
    document.getElementById("stockList").innerHTML = stockListHTML;
}

/* CAMERA SCANNING WITH INSTASCAN (Better iOS support) */
async function startScan(mode) {
    if (isProcessingScan) {
        console.log("Already processing a scan");
        return;
    }
    
    currentScanMode = mode;
    
    // Show camera container
    document.getElementById("cameraContainer").classList.remove("hidden");
    document.getElementById("scan-status").textContent = "Starting camera...";
    
    try {
        // Check if Instascan is available
        if (typeof Instascan === 'undefined') {
            throw new Error("Scanner library not loaded");
        }
        
        // Stop any existing scanner
        if (scanner) {
            scanner.stop();
            scanner = null;
        }
        
        // Create new scanner
        scanner = new Instascan.Scanner({
            video: document.getElementById('scanner-video'),
            mirror: currentCamera === 'user',
            scanPeriod: 5, // How often to scan (ms)
            backgroundScan: false,
            refractoryPeriod: 5000, // Time between scans (ms)
            continuous: true // Keep scanning
        });
        
        // Handle successful scan
        scanner.addListener('scan', async function(content) {
            if (isProcessingScan) return;
            
            console.log('QR Code detected:', content);
            
            // Visual feedback
            document.getElementById("scan-status").textContent = "✓ QR detected!";
            document.getElementById("scan-status").style.color = "#10B981";
            
            // Vibrate if available
            if (navigator.vibrate) navigator.vibrate(100);
            
            // Stop scanner
            scanner.stop();
            document.getElementById("cameraContainer").classList.add("hidden");
            
            // Process the scan
            await processScannedCode(content, mode);
            
            // Reset status
            document.getElementById("scan-status").textContent = "Position QR code in frame";
            document.getElementById("scan-status").style.color = "";
        });
        
        // Get available cameras
        const cameras = await Instascan.Camera.getCameras();
        
        if (cameras.length === 0) {
            throw new Error('No cameras found');
        }
        
        // Select camera based on preference
        let selectedCamera = null;
        
        if (currentCamera === 'environment') {
            // Try to find back camera
            selectedCamera = cameras.find(cam => cam.name.toLowerCase().includes('back') || 
                                                 cam.name.toLowerCase().includes('rear') ||
                                                 cam.name.includes('2')) || cameras[0];
        } else {
            // Try to find front camera
            selectedCamera = cameras.find(cam => cam.name.toLowerCase().includes('front') || 
                                                 cam.name.toLowerCase().includes('user') ||
                                                 cam.name.includes('1')) || cameras[0];
        }
        
        // Start scanner
        await scanner.start(selectedCamera);
        
        document.getElementById("scan-status").textContent = "Ready - Scan QR code";
        document.getElementById("scan-status").style.color = "";
        
    } catch (error) {
        console.error('Scanner error:', error);
        
        // Try fallback method
        if (!await tryFallbackScanner(mode)) {
            alert("Camera Error:\n\n" + 
                  "1. Grant camera permission\n" +
                  "2. Ensure you're using HTTPS\n" +
                  "3. Try refreshing the page\n\n" +
                  "Error: " + error.message);
            stopScan();
        }
    }
}

/* FALLBACK SCANNER USING FILE INPUT */
async function tryFallbackScanner(mode) {
    return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment'; // For mobile camera
        
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) {
                resolve(false);
                return;
            }
            
            // Create image element
            const img = new Image();
            img.onload = function() {
                // Create canvas to process image
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                // Get image data for QR detection
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Try to detect QR code manually (simplified)
                // Note: For production, use a proper QR library like jsQR
                alert("Image captured. Manual QR detection would go here.\n\n" +
                      "For now, please enter the QR code manually:");
                
                const manualCode = prompt("Enter QR Code content (ID###):");
                if (manualCode) {
                    processScannedCode(manualCode, mode);
                }
                
                resolve(true);
            };
            
            img.src = URL.createObjectURL(file);
        };
        
        input.oncancel = () => resolve(false);
        input.click();
    });
}

/* SWITCH CAMERA */
function switchCamera() {
    if (scanner && scanner.active) {
        currentCamera = currentCamera === 'environment' ? 'user' : 'environment';
        stopScan();
        setTimeout(() => startScan(currentScanMode), 500);
    }
}

/* STOP SCANNER */
function stopScan() {
    if (scanner) {
        scanner.stop();
        scanner = null;
    }
    
    // Hide camera container
    document.getElementById("cameraContainer").classList.add("hidden");
    
    // Clear video element
    const video = document.getElementById('scanner-video');
    video.srcObject = null;
    
    isProcessingScan = false;
    document.getElementById("scan-status").textContent = "Position QR code in frame";
    document.getElementById("scan-status").style.color = "";
}

/* PROCESS SCANNED CODE */
async function processScannedCode(serial, mode) {
    if (isProcessingScan) return;
    isProcessingScan = true;
    
    serial = serial.trim();
    
    // Validate QR format
    if (!serial.startsWith("ID")) {
        alert("Invalid QR code format. Expected: ID###\nScanned: " + serial);
        isProcessingScan = false;
        return;
    }
    
    console.log(`Processing ${mode}: ${serial}`);
    
    if (mode === "add") {
        // Check if already exists
        if (stock[serial]) {
            alert(`Already exists!\n\nSerial: ${serial}\nMaterial: ${stock[serial]}\n\nThis item is already in stock.`);
            isProcessingScan = false;
            return;
        }
        
        // Get material name
        let materialName = prompt(`Enter Material Name for: ${serial}\n\nMaterial Name:`);
        
        if (!materialName || materialName.trim() === "") {
            isProcessingScan = false;
            return;
        }
        
        materialName = materialName.trim();
        
        try {
            // Save to database
            await db.collection("materials").doc(serial).set({ material: materialName });
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Add",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`Added: ${materialName}\nSerial: ${serial}\n\nSuccessfully added to inventory.`);
            
            // Update stock display
            renderStock();
            
        } catch (error) {
            alert("Error saving to database: " + error.message);
        }
    }
    
    if (mode === "consume") {
        // Check if exists
        if (!stock[serial]) {
            alert(`Not found in stock!\n\nSerial: ${serial}\n\nThis item is not in the inventory.`);
            isProcessingScan = false;
            return;
        }
        
        let materialName = stock[serial];
        
        try {
            await db.collection("materials").doc(serial).delete();
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Consume",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`Consumed: ${materialName}\nSerial: ${serial}\n\nRemoved from inventory.`);
            
            // Update stock display
            renderStock();
            
        } catch (error) {
            alert("Error updating database: " + error.message);
        }
    }
    
    isProcessingScan = false;
}

/* EXPORT CSV */
function exportCSV() {
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;
    const filterType = document.getElementById("filterType").value;
    
    let rows = [["Serial", "Material", "Type", "Date"]];
    
    history.filter(entry => {
        let matches = true;
        if (filterType !== "ALL") matches = entry.type === filterType;
        
        const entryDate = new Date(entry.date.seconds * 1000);
        if (from) matches = matches && entryDate >= new Date(from);
        if (to) matches = matches && entryDate <= new Date(to + "T23:59:59");
        
        return matches;
    }).forEach(entry => {
        rows.push([
            entry.serial,
            entry.material,
            entry.type,
            new Date(entry.date.seconds * 1000).toLocaleString()
        ]);
    });
    
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, XLSX.utils.aoa_to_sheet(rows), "Inventory_Data");
    XLSX.writeFile(workbook, "Inventory_History.csv");
}

/* GENERATE QR PDF */
async function generateQR() {
    const n = parseInt(prompt("Number of QR codes to generate?"));
    if (!n || n < 1) {
        alert("Please enter a valid number");
        return;
    }
    
    const settingsDoc = await db.collection("settings").doc("qr").get();
    let last = 900;
    
    if (settingsDoc.exists) {
        last = settingsDoc.data().lastNumber || 900;
        if (last < 900) last = 900;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: "mm", format: [100, 150] });
    
    const qrSize = 25;
    const textGap = 3;
    const fontSize = 8;
    const marginX = 5;
    const marginY = 5;
    const qrPerRow = 4;
    const spacingX = (100 - 2 * marginX - qrPerRow * qrSize) / (qrPerRow - 1);
    const spacingY = 7;
    
    let x = marginX;
    let y = marginY;
    let col = 0;
    
    alert(`Generating ${n} QR codes... Please wait.`);
    
    for (let i = 1; i <= n; i++) {
        const id = "ID" + String(++last).padStart(3, "0");
        
        const canvas = document.createElement("canvas");
        await QRCode.toCanvas(canvas, id, {
            width: qrSize * 4,
            margin: 1,
            color: { dark: "#000000", light: "#FFFFFF" }
        });
        
        pdf.addImage(canvas, "PNG", x, y, qrSize, qrSize);
        pdf.setFontSize(fontSize);
        pdf.text(id, x + qrSize / 2, y + qrSize + textGap, { align: "center" });
        
        col++;
        if (col < qrPerRow) {
            x += qrSize + spacingX;
        } else {
            col = 0;
            x = marginX;
            y += qrSize + textGap + spacingY;
            
            if (y + qrSize + textGap > 150 - marginY) {
                pdf.addPage([100, 150]);
                y = marginY;
            }
        }
    }
    
    pdf.save(`QR_Codes_ID${String(last - n + 1).padStart(3, '0')}_to_ID${String(last).padStart(3, '0')}.pdf`);
    
    await db.collection("settings").doc("qr").set({ lastNumber: last });
    
    alert(`Generated ${n} QR codes\nFrom: ID${String(last - n + 1).padStart(3, '0')}\nTo: ID${String(last).padStart(3, '0')}`);
}

/* CLEANUP */
window.addEventListener('beforeunload', stopScan);
window.addEventListener('pagehide', stopScan);
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopScan();
    }
});

</script>
</body>
</html>
