<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guruvel Creativities Inventory</title>

  <!-- Tailwind CSS CDN for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Html5Qrcode library for QR scanning -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <!-- Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6 font-sans">
  <div class="max-w-3xl w-full bg-white rounded-lg shadow-lg p-6">
    <div class="flex items-center mb-6 space-x-4">
      <img class="w-24"
        src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgra2sfgJ1ZE0ub9g2_geCiFkRrdEhgzI_LQ7qkySYRO9ss4QHHWGTL-HlniFl5AuPq5uu7gtQKvrgyregnbofmhQau5V6kWzcwQcj7G-Wpl2tIXPIfEKOLUbX781JbJbNiQ04dK-Q1TzBS/s268/Screenshot+%25284%2529.png"
        alt="Logo" />
      <h1 class="text-3xl font-bold text-gray-800">Guruvel Creativities Inventory</h1>
    </div>

    <div class="flex flex-wrap gap-3 mb-6">
      <button class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="startScan('add')">➕ Add Stock</button>
      <button class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded shadow transition"
        onclick="startScan('consume')">➖ Consume</button>
      <!-- You can add generate QR code and export buttons here -->
    </div>

    <div id="reader" class="w-full rounded border border-gray-300 bg-gray-50 p-3 mb-4"></div>
    <button id="backButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded shadow transition mb-6 hidden"
      onclick="stopScan()">⬅️ Go Back</button>

    <div class="bg-gray-50 rounded p-4 shadow-inner">
      <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b border-gray-300 pb-2">Current Stock</h2>
      <div id="stockList" class="text-gray-800 text-lg min-h-[100px]">
        <i>No materials in stock.</i>
      </div>
    </div>
  </div>

  <script>
    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
      authDomain: "material-tracker-49dac.firebaseapp.com",
      projectId: "material-tracker-49dac",
      storageBucket: "material-tracker-49dac.appspot.com",
      messagingSenderId: "548291877330",
      appId: "1:548291877330:web:94a5d62b40058ad480100b"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const dbFirebase = firebase.firestore();

    // Local storage keys and data holders
    let db = {};
    let historyLog = [];
    let html5QrCode;
    let lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');

    // Save DB and history to localStorage
    function saveDB() {
      localStorage.setItem('materialDB', JSON.stringify(db));
      localStorage.setItem('materialHistory', JSON.stringify(historyLog));
      renderList();
    }

    // Render current stock list
    function renderList() {
      let stock = {};
      for (let serial in db) {
        let material = db[serial];
        stock[material] = (stock[material] || 0) + 1;
      }
      let html = Object.entries(stock).map(([mat, count]) => `<div>${mat}: ${count}</div>`).join('');
      document.getElementById('stockList').innerHTML = html || '<i>No materials in stock.</i>';
    }

    // Start scanning QR codes for 'add' or 'consume' mode
    async function startScan(mode) {
      document.getElementById("backButton").style.display = "inline";
      html5QrCode = new Html5Qrcode("reader");

      try {
        const devices = await Html5Qrcode.getCameras();
        if (!devices || devices.length === 0) {
          alert("No camera found on this device.");
          return;
        }
        // Prefer back camera if available
        const backCamera = devices.find(dev => dev.label.toLowerCase().includes("back")) || devices[0];

        await html5QrCode.start(
          { deviceId: backCamera.id },
          {
            fps: 20,                      // frames per second for scanning
            qrbox: { width: 300, height: 300 }, // scanning box size
            aspectRatio: 1.0,
            disableFlip: false
          },
          qrCodeMessage => {
            html5QrCode.stop();
            handleScan(qrCodeMessage, mode);
          },
          errorMessage => {
            // Optionally log scan errors here
            // console.debug("QR Code scan error:", errorMessage);
          }
        );
      } catch (err) {
        alert("Unable to start scanning: " + err);
      }
    }

    // Stop scanning and clean UI
    function stopScan() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById("backButton").style.display = "none";
          document.getElementById("reader").innerHTML = "";
        }).catch(err => {
          alert("Error stopping the scanner: " + err);
        });
      }
    }

    // Handle scanned QR code data
    async function handleScan(serial, mode) {
      serial = serial.trim();

      // Add stock flow
      if (mode === 'add' && /^ID\d{3,}$/.test(serial)) {
        let material = prompt("Enter or select material name:", "NodeMCU");
        if (!material) {
          return alert("Material name is required to add.");
        }
        material = material.trim();
        if (db[serial]) return alert('Already added.');

        db[serial] = material;
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Add', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        try {
          await dbFirebase.collection('materials').doc(serial).set({
            material,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material added successfully.');
        return;
      }

      // If scanned code is not serial ID for 'add' mode, assign new serial
      if (mode === 'add') {
        if (db[serial]) return alert('Already added.');

        lastSerialNum++;
        const newSerial = 'ID' + lastSerialNum.toString().padStart(3, '0');
        db[newSerial] = serial;
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Add', id: newSerial, material: serial };
        historyLog.push(historyEntry);
        saveDB();
        localStorage.setItem('lastSerial', lastSerialNum);

        try {
          await dbFirebase.collection('materials').doc(newSerial).set({
            material: serial,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          await dbFirebase.collection('history').add(historyEntry);
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material added with new serial: ' + newSerial);
        return;
      }

      // Consume stock flow
      if (mode === 'consume') {
        if (!db[serial]) return alert('Not in stock.');

        const material = db[serial];
        delete db[serial];
        const now = new Date().toISOString();
        const historyEntry = { date: now, type: 'Consume', id: serial, material };
        historyLog.push(historyEntry);
        saveDB();

        try {
          await dbFirebase.collection('history').add(historyEntry);
          await dbFirebase.collection('materials').doc(serial).delete();
        } catch (e) {
          alert("Firestore save error: " + e.message);
        }

        alert('Material consumed successfully.');
        return;
      }
    }

    // Load data from localStorage on page load
    window.onload = () => {
      db = JSON.parse(localStorage.getItem('materialDB') || '{}');
      historyLog = JSON.parse(localStorage.getItem('materialHistory') || '[]');
      lastSerialNum = parseInt(localStorage.getItem('lastSerial') || '0');
      renderList();
    };
  </script>
</body>

</html>
