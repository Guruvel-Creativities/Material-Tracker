<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Guruvel Creativities Inventory</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
    #reader {
        position: relative;
        background-color: #000;
    }
    
    #reader video {
        width: 100% !important;
        height: auto !important;
        object-fit: cover;
    }
    
    .zoom-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 100;
    }
    
    .zoom-btn {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        margin: 5px;
    }
    
    .zoom-btn:hover {
        background: rgba(0, 0, 0, 0.9);
    }
</style>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-3xl mx-auto bg-white rounded shadow p-6">

<!-- HEADER -->
<div class="flex items-center gap-4 mb-4">
<img class="w-20" src="https://raw.githubusercontent.com/Guruvel-Creativities/Material-Tracker/main/Logo.PNG" alt="Guruvel Creativities Logo">
<h1 class="text-2xl font-bold">Guruvel Creativities Inventory</h1>
</div>

<!-- MAIN BUTTONS -->
<div class="flex flex-wrap gap-2 mb-4">
<button onclick="generateQR()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Generate QR</button>
<button onclick="startScan('add')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add</button>
<button onclick="startScan('consume')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Consume</button>
</div>

<!-- MATERIAL SEARCH -->
<input id="searchInput" oninput="renderStock()" placeholder="Search material..."
class="w-full border p-2 rounded mb-4">

<!-- CAMERA CONTAINER - Hidden by default -->
<div id="cameraContainer" class="hidden mb-4">
    <div id="reader" class="border-4 border-blue-500 rounded-lg overflow-hidden max-w-xs mx-auto relative">
        <div class="zoom-controls">
            <button onclick="zoomIn()" class="zoom-btn">+</button>
            <button onclick="zoomOut()" class="zoom-btn">-</button>
        </div>
    </div>
    <div id="cameraStatus" class="text-center text-sm text-gray-600 mt-1">
        <div class="inline-flex items-center gap-1">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span>Camera active - Move closer for small QR codes</span>
        </div>
    </div>
    <div class="text-center mt-2">
        <button onclick="stopScan()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1.5 rounded text-sm">Stop Camera</button>
    </div>
</div>

<!-- STOCK -->
<div class="mt-4 bg-gray-50 p-4 rounded">
<h2 class="font-semibold mb-2">Current Stock</h2>
<div id="stockList"><i>Loading…</i></div>
</div>

<!-- EXPORT HISTORY -->
<div class="mt-6 bg-gray-50 p-4 rounded">
    <h2 class="font-semibold mb-2">Export History</h2>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">From:</label>
            <input type="date" id="fromDate" class="border p-1.5 rounded pl-11 w-full h-10 text-sm">
        </div>
        
        <div class="relative">
            <label class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm pointer-events-none mr-1">To:</label>
            <input type="date" id="toDate" class="border p-1.5 rounded pl-8 w-full h-10 text-sm">
        </div>
        
        <select id="filterType" class="border p-2 rounded h-10">
            <option value="ALL">All</option>
            <option value="Add">Add</option>
            <option value="Consume">Consume</option>
        </select>
        
        <button onclick="exportCSV()" class="bg-indigo-600 text-white rounded px-4 h-10 hover:bg-indigo-700">Export CSV</button>
    </div>
</div>

</div>

<script>
/* FIREBASE INIT */
firebase.initializeApp({
 apiKey: "AIzaSyBmXJZ6dm-SLzzIvz9P22kXI23MwdW3WC0",
 authDomain: "material-tracker-49dac.firebaseapp.com",
 projectId: "material-tracker-49dac"
});
const db = firebase.firestore();

/* DATA STORAGE */
let stock={}, history=[], qr, currentScanMode = null, isProcessingScan = false;
let currentZoom = 1;

/* REALTIME MATERIAL DATA */
db.collection("materials").onSnapshot(s=>{
 stock={}; 
 s.forEach(d=>stock[d.id]=d.data().material); 
 renderStock();
});

db.collection("history").orderBy("date","desc").onSnapshot(s=>{
 history=[]; 
 s.forEach(d=>history.push(d.data()));
});

/* RENDER STOCK */
function renderStock(){
 const t=document.getElementById("searchInput").value.toLowerCase();
 let c={};
 Object.values(stock).forEach(m=>{ if(m.toLowerCase().includes(t)) c[m]=(c[m]||0)+1; });
 document.getElementById("stockList").innerHTML=
 Object.entries(c).map(([m,n],i)=>`<div class="flex justify-between border-b py-1 hover:bg-gray-100">
 <span>${i+1}. ${m}</span><b>${n}</b></div>`).join("") || "<i>No match</i>";
}

/* ZOOM CONTROLS */
function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 3);
    applyZoom();
}

function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 1);
    applyZoom();
}

function applyZoom() {
    const videoElement = document.querySelector('#reader video');
    if (videoElement) {
        videoElement.style.transform = `scale(${currentZoom})`;
        videoElement.style.transformOrigin = 'center center';
    }
}

/* HIGH ACCURACY QR SCANNER */
async function startScan(mode){
    if (isProcessingScan) {
        console.log("Already processing a scan, please wait...");
        return;
    }
    
    currentScanMode = mode;
    currentZoom = 1;
    
    // Show camera container
    document.getElementById("cameraContainer").classList.remove("hidden");
    
    // Clear previous scanner
    document.getElementById("reader").innerHTML = '<div class="zoom-controls"><button onclick="zoomIn()" class="zoom-btn">+</button><button onclick="zoomOut()" class="zoom-btn">-</button></div>';
    
    try {
        // Create scanner with high accuracy settings
        qr = new Html5Qrcode("reader");
        
        // OPTIMIZED SETTINGS FOR SMALL QR CODES
        const config = {
            fps: 30,                    // Higher FPS for faster detection
            qrbox: { 
                width: 300,             // Larger scanning area
                height: 300 
            },
            aspectRatio: 1.0,
            disableFlip: false,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            },
            rememberLastUsedCamera: true,
            // Support multiple formats for better compatibility
            formatsToSupport: [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.AZTEC,
                Html5QrcodeSupportedFormats.CODABAR,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.CODE_93,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.DATA_MATRIX,
                Html5QrcodeSupportedFormats.MAXICODE,
                Html5QrcodeSupportedFormats.ITF,
                Html5QrcodeSupportedFormats.EAN_13,
                Html5QrcodeSupportedFormats.EAN_8,
                Html5QrcodeSupportedFormats.PDF_417,
                Html5QrcodeSupportedFormats.RSS_14,
                Html5QrcodeSupportedFormats.RSS_EXPANDED,
                Html5QrcodeSupportedFormats.UPC_A,
                Html5QrcodeSupportedFormats.UPC_E,
                Html5QrcodeSupportedFormats.UPC_EAN_EXTENSION
            ]
        };
        
        // Get camera capabilities
        const cameras = await Html5Qrcode.getCameras();
        let cameraId = null;
        
        // Try to find the highest resolution camera (usually back camera)
        if (cameras.length > 0) {
            // Sort cameras by likely resolution (cameras with 'back' or high numbers in ID)
            const sortedCameras = cameras.sort((a, b) => {
                const aIsBack = a.label.toLowerCase().includes('back') || a.label.toLowerCase().includes('rear') || a.label.toLowerCase().includes('2') || a.label.includes('2');
                const bIsBack = b.label.toLowerCase().includes('back') || b.label.toLowerCase().includes('rear') || b.label.toLowerCase().includes('2') || b.label.includes('2');
                return (bIsBack ? 1 : 0) - (aIsBack ? 1 : 0);
            });
            cameraId = sortedCameras[0].id;
        }
        
        console.log("Starting camera with high accuracy settings...");
        
        // Start with high resolution settings for better small QR detection
        await qr.start(
            cameraId || { facingMode: "environment" },
            config,
            async (decodedText) => {
                console.log("QR detected:", decodedText);
                
                // Beep sound for feedback
                beep();
                
                // Stop camera immediately
                try {
                    await qr.stop();
                } catch (e) {
                    console.log("Error stopping:", e);
                }
                
                // Hide camera container
                document.getElementById("cameraContainer").classList.add("hidden");
                
                // Process the scan
                await processScannedCode(decodedText, mode);
            },
            (errorMessage) => {
                // Silently handle scanning errors
                if (!errorMessage.includes("No QR code found") && 
                    !errorMessage.includes("NotFoundException")) {
                    console.log("Scan error:", errorMessage);
                }
            }
        ).then(() => {
            console.log("Camera started successfully");
            
            // Add focus message after camera starts
            setTimeout(() => {
                const status = document.getElementById('cameraStatus');
                if (status) {
                    status.innerHTML = '<div class="inline-flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span>✓ Camera ready - Move closer for small QR codes</span></div>';
                }
            }, 1000);
            
        }).catch(err => {
            console.error("Camera start error:", err);
            
            // Fallback to simpler settings
            startFallbackScan(mode);
        });
        
    } catch (err) {
        console.error("Initial camera start failed:", err);
        startFallbackScan(mode);
    }
}

/* FALLBACK SCANNER */
async function startFallbackScan(mode) {
    try {
        qr = new Html5Qrcode("reader");
        
        await qr.start(
            { facingMode: "environment" },
            {
                fps: 20,
                qrbox: { width: 280, height: 280 },
                aspectRatio: 1.0
            },
            async (decodedText) => {
                beep();
                try {
                    await qr.stop();
                } catch (e) {}
                document.getElementById("cameraContainer").classList.add("hidden");
                await processScannedCode(decodedText, mode);
            }
        );
        
    } catch (err) {
        console.error("Fallback also failed:", err);
        alert("Camera Error:\n\n1. Check camera permissions\n2. Ensure HTTPS is used\n3. Try a different browser\n\nError: " + err.message);
        stopScan();
    }
}

/* BEEP SOUND FEEDBACK */
function beep() {
    try {
        // Create a simple beep using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 1000;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
    } catch (e) {
        // Audio not supported, ignore
    }
}

/* PROCESS SCANNED CODE */
async function processScannedCode(serial, mode) {
    if (isProcessingScan) return;
    isProcessingScan = true;
    
    serial = serial.trim();
    
    // Validate QR format
    if(!serial.startsWith("ID")) {
        alert("Invalid QR code format. Expected: ID###\nScanned: " + serial);
        isProcessingScan = false;
        return;
    }
    
    console.log(`Processing ${mode}: ${serial}`);
    
    if(mode === "add"){
        // Check if already exists
        if(stock[serial]) {
            alert(`Already exists!\n\nSerial: ${serial}\nMaterial: ${stock[serial]}\n\nThis item is already in stock.`);
            isProcessingScan = false;
            return;
        }
        
        // Get material name with the serial displayed
        let materialName = prompt(`Enter Material Name for: ${serial}\n\nMaterial Name:`);
        
        if(!materialName || materialName.trim() === "") {
            isProcessingScan = false;
            return;
        }
        
        materialName = materialName.trim();
        
        try {
            // Save to database
            await db.collection("materials").doc(serial).set({material: materialName});
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Add",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Show success message
            alert(`Added: ${materialName}\nSerial: ${serial}\n\nSuccessfully added to inventory.`);
            
            // Update stock display
            renderStock();
            
        } catch (error) {
            alert("Error saving to database: " + error.message);
        }
    }
    
    if(mode === "consume"){
        // Check if exists
        if(!stock[serial]) {
            alert(`Not found in stock!\n\nSerial: ${serial}\n\nThis item is not in the inventory.`);
            isProcessingScan = false;
            return;
        }
        
        let materialName = stock[serial];
        
        try {
            await db.collection("materials").doc(serial).delete();
            await db.collection("history").add({
                serial: serial,
                material: materialName,
                type: "Consume",
                date: new Date(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert(`Consumed: ${materialName}\nSerial: ${serial}\n\nRemoved from inventory.`);
            
            // Update stock display
            renderStock();
            
        } catch (error) {
            alert("Error updating database: " + error.message);
        }
    }
    
    isProcessingScan = false;
}

/* STOP CAMERA */
async function stopScan(){
    isProcessingScan = false;
    currentZoom = 1;
    
    if(qr && qr.isScanning){
        try {
            await qr.stop();
            qr.clear();
        } catch (err) {
            console.log("Stop cleanup:", err);
        }
    }
    
    // Hide camera container
    document.getElementById("cameraContainer").classList.add("hidden");
    document.getElementById("reader").innerHTML = '<div class="zoom-controls"><button onclick="zoomIn()" class="zoom-btn">+</button><button onclick="zoomOut()" class="zoom-btn">-</button></div>';
    currentScanMode = null;
}

/* EXPORT CSV */
function exportCSV(){
 const from=document.getElementById("fromDate").value;
 const to=document.getElementById("toDate").value;
 const t=document.getElementById("filterType").value;
 let rows=[["Serial","Material","Type","Date"]];

 history.filter(h=>{
   let ok=true;
   if(t!=="ALL") ok=h.type===t;
   let dt=new Date(h.date.seconds*1000);
   if(from) ok=ok && dt>=new Date(from);
   if(to) ok=ok && dt<=new Date(to+"T23:59:59");
   return ok;
 }).forEach(h=>rows.push([h.serial,h.material,h.type,new Date(h.date.seconds*1000).toLocaleString()]));

 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),"Inventory_Data");
 XLSX.writeFile(wb,"Inventory_History.csv");
}

/* GENERATE QR PDF */
async function generateQR(){
  const n = parseInt(prompt("Number of QR codes to generate?"));
  if(!n || n < 1) {
      alert("Please enter a valid number");
      return;
  }

  const settingsDoc = await db.collection("settings").doc("qr").get();
  let last = 900;

  if(settingsDoc.exists){
      last = settingsDoc.data().lastNumber || 900;
      if(last < 900) last = 900;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:"mm", format:[100,150]});

  const qrSize = 25;
  const textGap = 3;
  const fontSize = 8;
  const marginX = 5;
  const marginY = 5;
  const qrPerRow = 4;
  const spacingX = (100 - 2*marginX - qrPerRow*qrSize) / (qrPerRow - 1);
  const spacingY = 7;

  let x = marginX;
  let y = marginY;
  let col = 0;

  alert(`Generating ${n} QR codes... Please wait.`);

  for(let i=1; i<=n; i++){
    const id = "ID" + String(++last).padStart(3,"0");

    const c = document.createElement("canvas");
    await QRCode.toCanvas(c, id, {
        width: qrSize * 4,
        margin: 1,
        color: {
            dark: "#000000",
            light: "#FFFFFF"
        }
    });

    pdf.addImage(c, "PNG", x, y, qrSize, qrSize);
    pdf.setFontSize(fontSize);
    pdf.text(id, x + qrSize/2, y + qrSize + textGap, {align:"center"});

    col++;
    if(col < qrPerRow){
      x += qrSize + spacingX;
    } else {
      col = 0;
      x = marginX;
      y += qrSize + textGap + spacingY;

      if(y + qrSize + textGap > 150 - marginY){
        pdf.addPage([100,150]);
        y = marginY;
      }
    }
  }

  pdf.save(`QR_Codes_ID${String(last-n+1).padStart(3,'0')}_to_ID${String(last).padStart(3,'0')}.pdf`);

  await db.collection("settings").doc("qr").set({lastNumber:last});
  
  alert(`Generated ${n} QR codes\nFrom: ID${String(last-n+1).padStart(3,'0')}\nTo: ID${String(last).padStart(3,'0')}`);
}

// Cleanup on page unload
window.addEventListener('beforeunload', stopScan);
window.addEventListener('pagehide', stopScan);
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopScan();
    }
});

</script>
</body>
</html>
